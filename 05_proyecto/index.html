<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Insta Chat</title>
    <style>
        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: #6a11cb; background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%); display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        
        .app-card { background: white; width: 380px; height: 550px; border-radius: 20px; box-shadow: 0 20px 50px rgba(0,0,0,0.3); display: flex; flex-direction: column; overflow: hidden; }
        .header { background: #2ecc71; color: white; padding: 20px; text-align: center; font-size: 22px; font-weight: bold; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        
        /* Pantalla de Inicio (Login) */
        #login-view { display: {{SHOW_LOGIN}}; flex-direction: column; justify-content: center; align-items: center; height: 100%; padding: 30px; text-align: center; }
        #login-view h3 { color: #333; margin-bottom: 20px; }
        
        /* Pantalla de Chat */
        #chat-view { display: {{SHOW_CHAT}}; padding: 15px; flex-grow: 1; display: flex; flex-direction: column; }
        #chat-window { flex-grow: 1; height: 320px; border: 1px solid #f0f0f0; overflow-y: auto; padding: 15px; background: #fdfdfd; border-radius: 12px; margin-bottom: 15px; }
        
        .msg { background: #f1f0f0; padding: 10px 14px; border-radius: 15px; margin-bottom: 10px; font-size: 14px; width: fit-content; max-width: 85%; line-height: 1.4; border-bottom-left-radius: 2px; color: #444; }
        .msg b { color: #2ecc71; display: block; font-size: 11px; margin-bottom: 2px; text-transform: uppercase; }
        
        input { width: 100%; padding: 14px; border: 2px solid #eee; border-radius: 30px; outline: none; transition: 0.3s; font-size: 14px; }
        input:focus { border-color: #2ecc71; }
        button { width: 100%; padding: 14px; background: #2ecc71; color: white; border: none; border-radius: 30px; cursor: pointer; font-weight: bold; margin-top: 10px; transition: 0.3s; }
        button:hover { background: #27ae60; transform: translateY(-2px); }
    </style>
</head>
<body>

    <div class="app-card">
        <div class="header">Insta Chat</div>

        <div id="login-view" style="display: {{SHOW_LOGIN}};">
            <h3>Â¡Bienvenido!</h3>
            <p>Introduce tu nombre para entrar a la sala de chat.</p>
            <form action="/" method="GET" style="width: 100%;">
                <input type="text" name="user" placeholder="Tu nombre..." required>
                <button type="submit">Entrar ahora</button>
            </form>
        </div>

        <div id="chat-view" style="display: {{SHOW_CHAT}};">
            <div id="chat-window">{{MESSAGES}}</div>
            <form id="form-msg">
                <input type="text" id="input-msg" placeholder="Escribe un mensaje..." required autocomplete="off">
                <button type="submit">Enviar</button>
            </form>
            <p style="text-align: center; font-size: 11px; color: #999; margin-top: 10px;">Conectado como: <b>{{USER_NAME}}</b></p>
        </div>
    </div>

    <script>
        const currentUser = "{{USER_NAME}}";
        const windowChat = document.getElementById('chat-window');

        // Actualizar mensajes cada 2 segundos sin recargar
        async function fetchMessages() {
            if (!currentUser) return;
            try {
                const res = await fetch('/update');
                const data = await res.text();
                if (windowChat.innerHTML !== data) {
                    windowChat.innerHTML = data;
                    windowChat.scrollTop = windowChat.scrollHeight;
                }
            } catch(e) {}
        }

        // Enviar mensajes por AJAX (evita que se borre lo que escribes)
        document.getElementById('form-msg')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const input = document.getElementById('input-msg');
            const val = input.value;
            input.value = ''; 
            
            await fetch(`/?user=${currentUser}&msg=${encodeURIComponent(val)}`);
            fetchMessages();
        });

        if (currentUser) {
            setInterval(fetchMessages, 2000);
            windowChat.scrollTop = windowChat.scrollHeight;
        }
    </script>
</body>
</html>